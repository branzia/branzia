on: push
name: ðŸš€ Deploy website on push

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    steps:

    - name: ðŸšš Get latest code (with submodules)
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ§° Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: ðŸ“¦ Install Composer dependencies
      run: composer install --no-interaction --prefer-dist --no-dev --optimize-autoloader

    - name: ðŸ§¹ Dump Autoload + Discover
      run: |
        rm -rf vendor/composer/autoload_*.php
        composer dump-autoload --optimize --no-dev
        php artisan config:clear
        php artisan route:clear
        php artisan cache:clear
        php artisan view:clear
        php artisan package:discover
        php artisan storage:link

    - name: ðŸ§· Set directory permissions
      run: chmod -R 775 storage bootstrap/cache

    - name: âš™ï¸ Generate .env file
      run: |
        echo "APP_NAME=Branzia" >> .env
        echo "APP_ENV=production" >> .env
        echo "APP_KEY=base64:f00mMyy0P+cbbvWW7HIszbeczHeAZnTpQ613yre/GL4=" >> .env
        echo "APP_DEBUG=false" >> .env
        echo "APP_URL=http://demo.branzia.co.in" >> .env
        echo "ASSET_URL=http://demo.branzia.co.in/public" >> .env
        echo "APP_LOCALE=en" >> .env
        echo "APP_FALLBACK_LOCALE=en" >> .env
        echo "APP_FAKER_LOCALE=en_US" >> .env
        echo "APP_MAINTENANCE_DRIVER=file" >> .env
        echo "LOG_CHANNEL=stack" >> .env
        echo "LOG_DEPRECATIONS_CHANNEL=null" >> .env
        echo "LOG_LEVEL=debug" >> .env
        echo "DB_CONNECTION=mysql" >> .env
        echo "DB_HOST=sql203.infinityfree.com" >> .env
        echo "DB_PORT=3306" >> .env
        echo "DB_DATABASE=if0_39285485_branzia" >> .env
        echo "DB_USERNAME=if0_39285485" >> .env
        echo "DB_PASSWORD=y0mXcK2L1ZU" >> .env

    - name: âœ… Create root index.php (wrapper)
      run: |
        echo "<?php require __DIR__ . '/public/index.php';" > index.php

    # ðŸ‘‡ Do NOT move public or copy index.php from it
    # ðŸ‘‡ Keep .htaccess inside /public/ (Apache uses it there)

    - name: ðŸ“‚ Deploy to InfinityFree via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ftpupload.net
        port: 21
        username: if0_39285485
        password: y0mXcK2L1ZU
        server-dir: /demo.branzia.co.in/htdocs/
        local-dir: ./
