on: push
name: ðŸš€ Deploy website on push

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    steps:

    - name: ðŸšš Get latest code (with submodules)
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ§° Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: ðŸ“¦ Install Composer dependencies
      run: composer install --no-interaction --prefer-dist

    - name: ðŸ§¹ Dump Autoload + Discover
      run: |
        composer dump-autoload
        php artisan package:discover

    - name: ðŸ§· Set directory permissions
      run: chmod -R 775 storage bootstrap/cache

    - name: âš™ï¸ Generate .env file
      run: |
        echo "APP_NAME=Laravel" >> .env
        echo "APP_ENV=production" >> .env
        echo "APP_KEY=base64:f00mMyy0P+cbbvWW7HIszbeczHeAZnTpQ613yre/GL4=" >> .env
        echo "APP_DEBUG=false" >> .env
        echo "APP_URL=https://yourapp.infinityfreeapp.com" >> .env
        echo "DB_CONNECTION=mysql" >> .env
        echo "DB_HOST=sql203.infinityfree.com" >> .env
        echo "DB_PORT=3306" >> .env
        echo "DB_DATABASE=if0_39285485_yourdb" >> .env
        echo "DB_USERNAME=if0_39285485" >> .env
        echo "DB_PASSWORD=y0mXcK2L1ZU" >> .env

    - name: Copy .htaccess from public
      run: cp public/.htaccess .htaccess

    - name: Prepare for shared hosting (move public files and fix paths)
      run: |
        cp public/index.php index.php
        sed -i "s|__DIR__.'/../vendor|__DIR__.'/vendor|g" index.php
        sed -i "s|__DIR__.'/../bootstrap|__DIR__.'/bootstrap|g" index.php
        rm -rf public

    - name: ðŸ“‚ Deploy to InfinityFree via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ftpupload.net
        port: 21
        username: if0_39285485
        password: y0mXcK2L1ZU
        server-dir: /htdocs/
        local-dir: ./